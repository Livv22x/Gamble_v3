<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Slot Machine - Casino Games</title>
    <script>
      (function(){
        try{
          if(localStorage.getItem('casino-dark-mode') === 'true'){
            document.documentElement.classList.add('dark-mode');
          }
          if(localStorage.getItem('casino-debug') === 'true'){
            document.documentElement.classList.add('debug');
          }
        }catch(e){}
      })();
    </script>
    <link rel="stylesheet" href="../css/styles.css" />
    <script src="../js/coin-system.js"></script>
  </head>
  <body>
    <div class="coin-display" title="Your Coins">
      <span class="coin-icon">ü™ô</span>
      <span class="coin-amount" data-coin-balance>0</span>
    </div>
    <div class="coin-reset-countdown"><span data-coin-countdown>Next reset in --:--:--</span></div>
    <div class="coin-actions">
      <button type="button" class="coin-btn coin-btn--secondary" aria-label="Remove 100 coins" onclick="window.Coins && Coins.spend(100)">-100</button>
      <button type="button" class="coin-btn" aria-label="Add 100 coins" onclick="window.Coins && Coins.add(100)">+100</button>
    </div>
    <div class="coin-debug-toggle">
      <button id="coin-debug-toggle-btn" type="button" class="coin-btn" onclick="toggleCoinDebug()">Enable Dev Coins</button>
    </div>
    <script>
      (function(){
        const AUTH_FLAG = 'casino-devcoins-auth';

        function setLabel(){
          var btn = document.getElementById('coin-debug-toggle-btn');
          if(!btn) return;
          var isOn = document.documentElement.classList.contains('debug');
          btn.textContent = isOn ? 'Disable Dev Coins' : 'Enable Dev Coins';
        }

        function isAuthorized(){
          try { return sessionStorage.getItem(AUTH_FLAG) === 'true'; } catch(e){ return false; }
        }

        function normalizeStr(s){
          try { return (s || '').normalize('NFKC').trim().toLowerCase(); } catch(e){ return (s || '').trim().toLowerCase(); }
        }

        function requestPassword(){
          const input = prompt('Enter password to enable Dev Coins:');
          if(input == null) return false;
          const val = normalizeStr(input);
          const pass1 = normalizeStr('Bj√∂rn');
          const pass2 = normalizeStr('Bjoern');
          if(val === pass1 || val === pass2){
            try { sessionStorage.setItem(AUTH_FLAG, 'true'); } catch(e){}
            return true;
          }
          alert('Wrong password.');
          return false;
        }

        window.toggleCoinDebug = function(){
          var html = document.documentElement;
          var currentlyOn = html.classList.contains('debug');
          if(!currentlyOn && !isAuthorized()){
            const ok = requestPassword();
            if(!ok){ setLabel(); return; }
          }
          var isOn = html.classList.toggle('debug');
          try { localStorage.setItem('casino-debug', isOn ? 'true' : 'false'); } catch(e){}
          setLabel();
        };
        if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', setLabel); else setLabel();
      })();
    </script>
    <div class="dark-mode-toggle">
      <label class="label">
        <div class="toggle">
          <input class="toggle-state" type="checkbox" id="dark-mode-switch" name="dark-mode" aria-label="Toggle dark mode" />
          <div class="indicator"></div>
        </div>
        <span class="switch-text">Dark Mode</span>
      </label>
    </div>
    <div class="container">
      <a href="../index.html" class="back-button">‚Üê Back to Home</a>
      <h1>Slot Machine</h1>

      <div class="game-area">
        <div class="slot-reels">
          <div class="reel" id="reel1">üçí</div>
          <div class="reel" id="reel2">üçã</div>
          <div class="reel" id="reel3">üîî</div>
        </div>

        <div class="game-controls">
          <label for="betAmount">Bet (coins):</label>
          <input type="number" id="betAmount" min="1" value="10" />
          <button id="spin-button" class="game-button">Spin</button>
        </div>

        <div id="slot-message"></div>

        <div class="coin-rules" aria-label="Coin rules for Slot Machine">
          <p><strong>Rules:</strong></p>
          <p>Each spin costs your chosen bet (stake).</p>
          <p>Three-of-a-kind (Jackpot): pays 10√ó your bet (stake already deducted).</p>
          <p>Any two matching: pays 3√ó your bet (stake already deducted).</p>
          <p>No match: no payout.</p>
        </div>
      </div>
    </div>

    <script>
      const symbols = ["üçí", "üçã", "üîî", "üçÄ", "7Ô∏è‚É£", "üíé"];

      function randSymbol() {
        return symbols[Math.floor(Math.random() * symbols.length)];
      }

      function setReel(id, symbol) {
        document.getElementById(id).textContent = symbol;
      }

      function evaluate(r1, r2, r3) {
        if (r1 === r2 && r2 === r3)
          return { message: "JACKPOT! Big win!", level: "big" };
        if (r1 === r2 || r1 === r3 || r2 === r3)
          return { message: "Nice! You matched two symbols!", level: "small" };
        return { message: "No match. Try again!", level: "none" };
      }

      async function spin() {
        const btn = document.getElementById("spin-button");
        const bet = Math.max(1, parseInt(document.getElementById('betAmount').value) || 1);
        // coin system: spin costs bet
        if (!window.Coins || !Coins.trySpend(bet)) {
          const msg = document.getElementById('slot-message');
          msg.textContent = 'Not enough coins for this bet.';
          msg.classList.remove('msg-big','msg-small');
          msg.classList.add('msg-none');
          return;
        }
        btn.disabled = true;
        document.getElementById("slot-message").textContent = "";

        // simple spin animation: change symbols for a short while, then stop sequentially
        const durations = [800, 1100, 1400];
        const results = [null, null, null];

        for (let i = 0; i < 3; i++) {
          const id = "reel" + (i + 1);
          const end = Date.now() + durations[i];
          while (Date.now() < end) {
            setReel(id, randSymbol());
            // short pause
            await new Promise((r) => setTimeout(r, 80));
          }
          // final symbol
          const finalSym = randSymbol();
          setReel(id, finalSym);
          results[i] = finalSym;
        }

        const res = evaluate(results[0], results[1], results[2]);
        const msgEl = document.getElementById("slot-message");
        msgEl.textContent = res.message;
        // remove previous level classes and add the appropriate one
        msgEl.classList.remove('msg-big', 'msg-small', 'msg-none');
        if (res.level === 'big') msgEl.classList.add('msg-big');
        else if (res.level === 'small') msgEl.classList.add('msg-small');
        else msgEl.classList.add('msg-none');

        // coin rewards proportional to bet
        if (window.Coins) {
          if (res.level === 'big') Coins.add(bet * 10);
          else if (res.level === 'small') Coins.add(bet * 3);
        }

        btn.disabled = false;
      }

      document.getElementById("spin-button").addEventListener("click", spin);
    </script>
    <script src="../js/darkmode.js"></script>
    <script src="../js/age-verify.js"></script>
  </body>
</html>
