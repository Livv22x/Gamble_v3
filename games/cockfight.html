<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cockfight Game</title>
        <script>
            (function(){
                try{
                    if(localStorage.getItem('casino-dark-mode') === 'true'){
                        document.documentElement.classList.add('dark-mode');
                    }
                }catch(e){}
            })();
        </script>
        <script>
            (function(){
                try{
                    if(localStorage.getItem('casino-dark-mode') === 'true'){
                        document.documentElement.classList.add('dark-mode');
                    }
                    if(localStorage.getItem('casino-debug') === 'true'){
                        document.documentElement.classList.add('debug');
                    }
                }catch(e){}
            })();
        </script>
        <link rel="stylesheet" href="../css/styles.css">
        <script src="../js/coin-system.js"></script>
</head>
<body>
        <div class="coin-display" title="Your Coins">
            <span class="coin-icon">ü™ô</span>
            <span class="coin-amount" data-coin-balance>0</span>
        </div>
        <div class="coin-actions">
            <button type="button" class="coin-btn coin-btn--secondary" aria-label="Remove 100 coins" onclick="window.Coins && Coins.spend(100)">-100</button>
            <button type="button" class="coin-btn" aria-label="Add 100 coins" onclick="window.Coins && Coins.add(100)">+100</button>
        </div>
        <div class="coin-debug-toggle">
            <button id="coin-debug-toggle-btn" type="button" class="coin-btn" onclick="toggleCoinDebug()">Enable Dev Coins</button>
        </div>
        <script>
            (function(){
                function setLabel(){
                    var btn = document.getElementById('coin-debug-toggle-btn');
                    if(!btn) return;
                    var isOn = document.documentElement.classList.contains('debug');
                    btn.textContent = isOn ? 'Disable Dev Coins' : 'Enable Dev Coins';
                }
                window.toggleCoinDebug = function(){
                    var html = document.documentElement;
                    var isOn = html.classList.toggle('debug');
                    try { localStorage.setItem('casino-debug', isOn ? 'true' : 'false'); } catch(e){}
                    setLabel();
                };
                if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', setLabel); else setLabel();
            })();
        </script>
        <div class="coin-actions">
            <button type="button" class="coin-btn" aria-label="Add 100 coins" onclick="window.Coins && Coins.add(100)">+100</button>
        </div>
    <div class="dark-mode-toggle">
      <label class="switch">
        <input type="checkbox" id="dark-mode-switch" />
        <span class="slider" aria-hidden="true"></span>
        <span class="switch-text">Dark Mode</span>
      </label>
    </div>
    <div class="cockfight-container">
        <h1>Cockfight Game</h1>
        <div class="cockfight-arena">
            <div class="cock left" id="cock1">üêì</div>
            <div class="cock right" id="cock2">üêì</div>
        </div>
                <div class="game-controls">
                    <label for="betAmount">Bet (coins):</label>
                    <input type="number" id="betAmount" min="1" value="5" />
                    <button id="fight-button">Start Fight</button>
                </div>
        <p id="result" aria-live="polite"></p>
        <a href="../index.html" class="back-link">Back to Home</a>

                <div class="coin-rules" aria-label="Coin rules for Cockfight">
                    <h4>Coin Rules</h4>
                    <ul>
                        <li>Start fight costs your chosen bet (stake/viewing fee).</li>
                        <li>No payouts in this demo.</li>
                    </ul>
                </div>
    </div>

    <script>
        const fightButton = document.getElementById('fight-button');
        const result = document.getElementById('result');
        const cock1 = document.getElementById('cock1');
        const cock2 = document.getElementById('cock2');
        const arena = document.querySelector('.cockfight-arena');

        // WebAudio setup (no external files)
        let audioCtx = null;
        let flapInterval = null;

        function ensureAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function beep(freq = 440, duration = 0.1, type = 'sine', vol = 0.08) {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type;
            o.frequency.setValueAtTime(freq, now);
            g.gain.setValueAtTime(vol, now);
            g.gain.exponentialRampToValueAtTime(0.001, now + duration);
            o.connect(g);
            g.connect(audioCtx.destination);
            o.start(now);
            o.stop(now + duration + 0.02);
        }

        function playCrowd(duration = 0.9) {
            if (!audioCtx) return;
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * (1 - i / bufferSize);
            const src = audioCtx.createBufferSource();
            src.buffer = buffer;
            const lp = audioCtx.createBiquadFilter();
            lp.type = 'lowpass';
            lp.frequency.value = 1800;
            const g = audioCtx.createGain();
            g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.02);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            src.connect(lp);
            lp.connect(g);
            g.connect(audioCtx.destination);
            src.start();
            src.stop(audioCtx.currentTime + duration + 0.02);
        }

        function startFlapSounds() {
            ensureAudio();
            // play an immediate flap and then small repeated flaps
            beep(360, 0.06, 'square', 0.05);
            flapInterval = setInterval(() => beep(360, 0.06, 'square', 0.05), 160);
        }

        function stopFlapSounds() {
            if (flapInterval) {
                clearInterval(flapInterval);
                flapInterval = null;
            }
        }

        function playJumpSound() {
            ensureAudio();
            beep(900, 0.24, 'sawtooth', 0.14);
        }

        function clearCockClasses() {
            [cock1, cock2].forEach(c => {
                c.classList.remove('flap','shake','jump','winner','loser');
                c.style.opacity = '';
            });
        }

        fightButton.addEventListener('click', () => {
            const bet = Math.max(1, parseInt(document.getElementById('betAmount').value) || 1);
            if (window.Coins && !Coins.trySpend(bet)) {
                result.textContent = 'Not enough coins for this bet.';
                return;
            }
            // resume audio context on user gesture (some browsers require this)
            ensureAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            fightButton.disabled = true;
            result.textContent = 'Fight!';
            arena.classList.add('fighting');

            // quick warm-up flap (visual + sound)
            cock1.classList.add('flap');
            cock2.classList.add('flap');
            startFlapSounds();

            // after short flap, decide winner and animate
            setTimeout(() => {
                cock1.classList.remove('flap');
                cock2.classList.remove('flap');
                stopFlapSounds();

                const winner = Math.random() < 0.5 ? cock1 : cock2;
                const loser = winner === cock1 ? cock2 : cock1;

                // play jump and crowd sounds with timings
                winner.classList.add('jump','winner');
                playJumpSound();
                setTimeout(() => playCrowd(1.1), 150);

                loser.classList.add('shake','loser');

                result.textContent = (winner === cock1) ? 'Cock 1 wins the fight!' : 'Cock 2 wins the fight!';

                // cleanup after animations
                setTimeout(() => {
                    clearCockClasses();
                    arena.classList.remove('fighting');
                    fightButton.disabled = false;
                }, 1600);
            }, 1000);
        });
    </script>
    <script src="../js/darkmode.js"></script>
    <script src="../js/age-verify.js"></script>
</body>
</html>